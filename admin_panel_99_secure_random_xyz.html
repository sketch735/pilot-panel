<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OF-PILOT Admin</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #1e1e1e; padding: 25px; border-radius: 15px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2b2b2b; color: white; flex: 1; min-width: 150px; }
        button { padding: 12px 20px; cursor: pointer; background: #00aff0; border: none; color: white; border-radius: 8px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #333; text-align: left; }
        .del { background: #ff4d4d; padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; color: white; }
        .date-edit { background: #2b2b2b; color: #00aff0; border: 1px solid #444; padding: 5px; border-radius: 5px; }
        
        /* RGB Динамический цвет для Username */
        .user-col { 
            font-weight: bold;
            font-size: 1em;
            background: linear-gradient(to right, #ef5350, #f48fb1, #7e57c2, #2196f3, #26c6da, #43a047, #eeff41, #f9a825, #ff5722);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 5s ease infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Управление ключами OF-PILOT</h2>
        <div class="input-group">
            <input type="text" id="username" placeholder="Имя пользователя (кому ключ)">
            <input type="text" id="key" placeholder="PRO-XXXXX">
            <button onclick="gen()">ГЕН</button>
            <input type="date" id="date">
            <button onclick="add()">Добавить</button>
        </div>
        <table id="t">
            <thead><tr><th>Пользователь</th><th>Ключ</th><th>До (изменяемо)</th><th>Действие</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
    // Проверка пароля при входе
    const pass = prompt("Введите пароль для доступа:");
    if (pass !== "СЮДА_ПИШИ_СВОЙ_ПАРОЛЬ") { 
        alert("Доступ запрещен!");
        document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:50px;'>403 Forbidden: Доступ ограничен</h1>";
        throw new Error("Stop"); // Останавливает выполнение остального скрипта
    }

    const SB_URL = 'https://kgzjnhytmlstyllibvjt.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnempuaHl0bWxzdHlsbGlidmp0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTAwNDYxNCwiZXhwIjoyMDg2NTgwNjE0fQ.1P50LKi0BoQDzpcngM4s6q74j0Jkw-FSQWe_qYT2ZmQ';

    function gen() { 
        const randomStr = Math.random().toString(36).substring(2, 10).toUpperCase();
        document.getElementById('key').value = 'PRO-' + randomStr; 
        const d = new Date(); d.setDate(d.getDate() + 30);
        document.getElementById('date').value = d.toISOString().split('T')[0];
    }

    async function load() {
        const res = await fetch(`${SB_URL}/rest/v1/profiles?order=created_at.desc`, { 
            headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}` } 
        });
        const data = await res.json();
        const b = document.querySelector('#t tbody'); 
        b.innerHTML = ''; // Очищаем таблицу перед загрузкой

        data.forEach(u => {
            const expireDate = u.expiry_date ? u.expiry_date.split('T')[0] : '—';
            b.innerHTML += `<tr>
                <td class="user-col">${u.username || '—'}</td>
                <td style="color:#00aff0; font-family:monospace; font-weight:bold;">${u.license_key}</td>
                <td><input type="date" class="date-edit" value="${expireDate}" onchange="updateDate('${u.id}', this.value)"></td>
                <td><button class="del" onclick="del('${u.id}')">Удалить</button></td>
            </tr>`;
        });
    }

    async function updateDate(id, newDate) {
        await fetch(`${SB_URL}/rest/v1/profiles?id=eq.${id}`, {
            method: 'PATCH',
            headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ expiry_date: newDate })
        });
    }

    async function add() {
        const key = document.getElementById('key').value.trim();
        const date = document.getElementById('date').value;
        const user = document.getElementById('username').value.trim();
        if (!key || !date) return alert('Заполни поля!');
        
        await fetch(`${SB_URL}/rest/v1/profiles`, {
            method: 'POST',
            headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
            body: JSON.stringify({ license_key: key, expiry_date: date, username: user, email: "pilot_user" })
        });
        load();
    }

    async function del(id) {
        if (confirm('Удалить?')) {
            await fetch(`${SB_URL}/rest/v1/profiles?id=eq.${id}`, { 
                method: 'DELETE', headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}` } 
            });
            load();
        }
    }
    load();
    </script>
</body>
</html>